Create a list of installed packages:
pacman -Qqe > $HOME/.pkglist/pkglist.txt

Create a list of optional dependencies:
comm -13 <(pacman -Qqdt | sort) <(pacman -Qqdtt | sort) > $HOME/.pkglist/optdeplist.txt

Create a list of AUR and other foreign packages that have been installed:
pacman -Qqem > $HOME/.pkglist/foreignpkglist.txt

Install without foreign packages:
pacman -S --needed $(comm -12 <(pacman -Slq | sort) <(sort $HOME/.pkglist/pkglist.txt))

Install only foreign packages:
paru -S $(comm -13 <(pacman -Slq | sort) <(sort $HOME/.pkglist/pkglist.txt))
